{% extends "base.html" %}

{% block content %}
    <div class="page_title white_text">Корзина</div>
    <div class="cart-container">
        <div class="cart-items">
            {% for item in cart_items %}
            <div class="card" data-prod-id="{{ item.prod_id }}" data-count="{{ item.count }}">
                <img src="{{ item.image }}" alt="Товар">
                <div class="cart-item-card-details">
                    <div class="cart-item-card-details-top">
                        <div class="cart-item-card-title">{{ item.title }}</div>
                        <button class="cart-item-card-delete-button">Удалить</button>
                    </div>
                    <div class="cart-item-card-details-bottom">
                        <div class="cart-item-price">{{ item.price }} Р</div>
                        <div class="cart-item-count-container">
                            <button class="cart-item-count-minus-button">-</button>
                            <div class="cart-item-count-count">{{ item.amount }}</div>
                            <button class="cart-item-count-plus-button">+</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="order-summary">
            <div class="order-summary-price-container">
                <div>Итоговая стоимость</div>
                <div class="price">{{total_price}} Р</div>
            </div>
            <button class="order-summary-button {% if not cart_items %}disabled{% endif %}" 
                    onclick="{% if cart_items %}location.href='order'{% endif %}">
                Перейти к оформлению заказа
            </button>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Функция для обновления итоговой стоимости
            function updateTotalPrice() {
                fetch('/api/cart/total')
                    .then(response => response.json())
                    .then(data => {
                        document.querySelector('.order-summary .price').textContent = data.total_price + ' Р';
                        // Обновляем состояние кнопки оформления заказа
                        const orderButton = document.querySelector('.order-summary-button');
                        if (data.total_items === 0) {
                            orderButton.classList.add('disabled');
                            orderButton.onclick = null;
                        } else {
                            orderButton.classList.remove('disabled');
                            orderButton.onclick = function() { location.href = 'order'; };
                        }
                    });
            }

            // Обработчики для кнопок изменения количества
            document.querySelectorAll('.card').forEach(function(element) {
                const itemId = element.getAttribute('data-prod-id');
                const countElement = element.querySelector('.cart-item-count-count');
                const minusButton = element.querySelector('.cart-item-count-minus-button');
                const plusButton = element.querySelector('.cart-item-count-plus-button');
                const deleteButton = element.querySelector('.cart-item-card-delete-button');

                // Обработчик для кнопки "+"
                plusButton.addEventListener('click', function() {
                    fetch('/api/cart/increase/' + itemId, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            countElement.textContent = data.new_amount;
                            minusButton.disabled = false;
                            updateTotalPrice();
                        }
                    });
                });

                // Обработчик для кнопки "-"
                minusButton.addEventListener('click', function() {
                    fetch('/api/cart/decrease/' + itemId, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            countElement.textContent = data.new_amount;
                            if (data.new_amount <= 1) {
                                minusButton.disabled = true;
                            }
                            if (data.new_amount === 0) {
                                element.remove();
                            }
                            updateTotalPrice();
                        }
                    });
                });

                // Обработчик для кнопки удаления
                deleteButton.addEventListener('click', function() {
                    fetch('/api/cart/remove/' + itemId, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            element.remove();
                            updateTotalPrice();
                        }
                    });
                });

                // Инициализация состояния кнопки "-"
                if (parseInt(countElement.textContent) <= 1) {
                    minusButton.disabled = true;
                }
            });
        });
    </script>

{% endblock %}