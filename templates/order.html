{% extends "base.html" %}

{% block content %}
    <div class="page_title white_text">Ваш заказ</div>
    <div class="order-container">
        <div class="order-items">
            {% for item in order_items %}
                <div class="card" data-prod-id="{{ item.prod_id }}" data-count="{{ item.count }}">
                <img src="{{ item.image }}" alt="Товар">
                <div class="order-item-card-details">
                    <div class="order-item-card-details-top">
                        <div class="order-item-card-title">{{ item.title }}</div>
                    </div>
                    <div class="order-item-card-details-bottom">
                        <div class="order-item-price">{{ item.price }} Р</div>
                        <div class="order-item-count-container">
                            <div class="order-item-count-count">х {{ item.amount }}</div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>  

        <div class="order-options">
            <div class="order-summary-price-container">
                <div>Итоговая стоимость</div>
                <div class="price">{{total_price}} Р</div>
            </div>
            
            <div class="checkbox-order-container">
                <input type="checkbox" class="pickup-option" id="pickup" name="pickup">
                <label class="remember_me_text" for="pickup">Забрать на баре</label>
                <input type="checkbox" class="dining-option" id="dining" name="dining">
                <label class="remember_me_text" for="dining">Заказать на стол</label>
            </div>
            
            <!-- Добавляем элемент для сообщения о номере стола -->
            <div id="tableNumberMessage" class="table-message"></div>
            
            <button class="button" id="confirmOrder">Оплатить</button>
        </div>
    </div>
    
    <script>
        const tableMessageDiv = document.getElementById('tableNumberMessage');
        const confirmButton = document.getElementById('confirmOrder');
        const diningCheckbox = document.getElementById('dining');
        const pickupCheckbox = document.getElementById('pickup');
    
        // Функция для обновления цвета кнопки в зависимости от чекбоксов
        function updateButtonState() {
            if (diningCheckbox.checked || pickupCheckbox.checked) {
                confirmButton.style.backgroundColor = '';
                confirmButton.disabled = false;
                confirmButton.style.cursor = 'pointer';
            } else {
                confirmButton.style.backgroundColor = '#8C8C8C';
                confirmButton.disabled = true;
                confirmButton.style.cursor = 'default';
            }
        }
        updateButtonState();
    
        // Добавим слушатели на чекбоксы
        diningCheckbox.addEventListener('change', () => {
            updateButtonState();
            if (diningCheckbox.checked) {
                tableMessageDiv.textContent = 'Ваш стол № 1';
            } else {
                tableMessageDiv.textContent = '';
            }
        });
    
        pickupCheckbox.addEventListener('change', () => {
            updateButtonState();
        });
    
        // Обработчик для кнопки подтверждения
        confirmButton.addEventListener('click', () => {
            if (!(diningCheckbox.checked || pickupCheckbox.checked)) {
                // Если ни один чекбокс не выбран, ничего не делать (кнопка отключена, но на всякий случай)
                return;
            }
            if (diningCheckbox.checked) {
                tableMessageDiv.textContent = 'Ваш стол № 1';
            }
            createOrder();
        });
    
        function createOrder() {
            fetch('/api/order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    // Добавьте сюда необходимые данные для заказа
                })
            })
            .then(response => {
                if (!response.ok) throw new Error('Ошибка сети');
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log(data);
                    window.location.href = '/profile';
                } else {
                    alert(data.message || 'Ошибка');
                }
            })
            .catch(() => alert('Ошибка при отправке запроса'));
        }
    </script>
{% endblock %}